<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Banco UNI - Inicio</title>
    <link rel="icon" type="image/png" href="/icono.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
  </head>
  <style>
    html {
      font-size: 14px;
    }

    #tabla-transacciones td,
    #tabla-transacciones thead {
      font-size: 0.9rem;
    }

    .dataTables_info {
      font-size: 0.8rem;
    }

    .pagination {
      font-size: 0.8rem;
    }
  </style>
  <body class="bg-light min-h-100vh">
    <div class="container py-3" style="height: 90vh">
      <div class="row justify-content-center">
        <div
          class="flex-grow-1 d-flex align-items-between justify-content-center"
        >
          <div class="card shadow p-4" style="max-width: 550px; width: 100%">
            <div class="mb-2 text-center">
              <h2 class="fw-bold">Banco UNI</h2>
              <p class="text-muted">Bienvenido, <%= usuario %>!</p>
              <button
                id="btn-qr"
                class="btn btn-outline-primary btn-sm mt-2"
                type="button"
              >
                Generar mi QR
              </button>
            </div>
            <div class="mb-2">
              <h5>Saldo actual:</h5>
              <div class="display-6 fw-bold text-success">$ <%= saldo %></div>
            </div>
            <hr />
            <div class="mb-4">
            <div class="mb-4">
              <h5 class="mb-3">Solicitar préstamo</h5>
              <form id="form-prestamo" class="row g-3">
                <div class="col-8 col-md-10">
                  <input
                    type="number"
                    class="form-control"
                    id="monto-prestamo"
                    name="monto"
                    min="1"
                    step="any"
                    placeholder="Monto a solicitar"
                    required
                  />
                </div>
                <div class="col-4 col-md-2 d-grid">
                  <button type="submit" class="btn btn-success">Pedir</button>
                </div>
              </form>
            </div>
              <h5 class="mb-3">Realizar transferencia</h5>
              <% if (error) { %>
              <div class="alert alert-danger py-2"><%= error %></div>
              <% } %> <% if (mensaje) { %>
              <div class="alert alert-success py-2"><%= mensaje %></div>
              <% } %>
              <form method="post" action="/transfer" class="row g-3">
                <div class="col-12 col-md-7">
                  <input
                    type="text"
                    class="form-control"
                    id="destino"
                    name="destino"
                    placeholder="Usuario destino"
                    required
                  />
                </div>
                <div class="col-8 col-md-3">
                  <input
                    type="number"
                    class="form-control"
                    id="monto"
                    name="monto"
                    min="1"
                    step="any"
                    placeholder="Monto"
                    required
                  />
                </div>
                <div class="col-4 col-md-2 d-grid">
                  <button type="submit" class="btn btn-primary">Enviar</button>
                </div>
              </form>
            </div>

            <div class="mb-4">
              <h5 class="mb-3">Últimas transacciones</h5>
              <div class="table-responsive">
                <table
                  id="tabla-transacciones"
                  class="table table-striped table-hover align-middle mb-0"
                  style="width: 100%"
                >
                  <thead class="table-light">
                    <tr>
                      <th>Fecha</th>
                      <th>Usuario destino</th>
                      <th>Monto</th>
                      <th>Estado</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (transacciones && transacciones.length > 0) { %> <%
                    transacciones.forEach(function(tx) { %>
                    <tr>
                      <td><%= tx.fecha %></td>
                      <td><%= tx.destino %></td>
                      <td
                        class="fw-bold <%= tx.tipo === 'Ingreso' ? 'text-success' : 'text-danger' %>"
                      >
                        $ <%= tx.monto %>
                      </td>
                      <td>
                        <% if (tx.tipo === 'Ingreso') { %>
                        <span class="badge bg-success">Ingreso</span>
                        <% } else if (tx.tipo === 'Salida') { %>
                        <span class="badge bg-danger">Salida</span>
                        <% } else { %>
                        <span class="badge bg-secondary">-</span>
                        <% } %>
                      </td>
                    </tr>
                    <% }); %> <% } %>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mt-4 text-center">
              <a href="/logout" class="btn btn-outline-secondary"
                >Cerrar sesión</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery, DataTables y Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    />
    <script>
      // Lógica para solicitar préstamo
      document.getElementById("form-prestamo").addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = e.target;
        const monto = form["monto"].value;
        Swal.fire({
          title: "Procesando...",
          html: "<div class='spinner-border text-primary' role='status'><span class='visually-hidden'>Cargando...</span></div>",
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
        try {
          const res = await fetch("/prestamo", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ monto }),
          });
          const result = await res.json();
          Swal.close();
          if (result.error) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: result.error,
              toast: true,
              position: "bottom-end",
              timer: 3000,
              showConfirmButton: false,
            });
          } else {
            // Actualizar saldo
            document.querySelector(
              ".display-6.fw-bold.text-success"
            ).textContent = "$ " + result.saldo;
            // Actualizar tabla de transacciones usando DataTable
            const table = $("#tabla-transacciones").DataTable();
            table.clear();
            if (result.transacciones && result.transacciones.length > 0) {
              result.transacciones.forEach(function (tx) {
                table.row.add([
                  tx.fecha,
                  tx.destino || tx.origen || "",
                  `<span class='fw-bold ${
                    tx.tipo === "Ingreso" ? "text-success" : tx.tipo === "Préstamo" ? "text-primary" : "text-danger"
                  }'>$ ${tx.monto}</span>`,
                  tx.tipo === "Ingreso"
                    ? '<span class="badge bg-success">Ingreso</span>'
                    : tx.tipo === "Salida"
                    ? '<span class="badge bg-danger">Salida</span>'
                    : tx.tipo === "Préstamo"
                    ? '<span class="badge bg-primary">Préstamo</span>'
                    : '<span class="badge bg-secondary">-</span>',
                ]);
              });
            }
            table.draw();
            Swal.fire({
              icon: "success",
              title: "Préstamo otorgado",
              toast: true,
              position: "bottom-end",
              timer: 3000,
              showConfirmButton: false,
            });
            form.reset();
          }
        } catch (err) {
          Swal.close();
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Error de red o servidor.",
            toast: true,
            position: "bottom-end",
            timer: 3000,
            showConfirmButton: false,
          });
        }
      });
      $(document).ready(function () {
        $("#tabla-transacciones").DataTable({
          language: {
            url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json",
          },
          order: [[0, "desc"]],
          pageLength: 5,
          lengthMenu: [5, 10, 25, 50],
          columnDefs: [
            { targets: 2, className: "fw-bold" },
            { targets: 3, className: "text-center" },
          ],
        });
      });
      document.getElementById("btn-qr").addEventListener("click", function () {
        const cuentaId = "<%= id %>";
        Swal.fire({
          title: "Mi QR para recibir depósitos",
          html: `<div class='d-flex flex-column align-items-center'><img src='/qr' alt='QR' style='width:200px;height:200px;'/></div>`,
          showCloseButton: true,
          showConfirmButton: false,
        });
      });
    </script>
    <script>
      document
        .querySelector('form[action="/transfer"]')
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const form = e.target;
          const data = {
            destino: form.destino.value,
            monto: form.monto.value,
          };
          // Mostrar animación de cargando
          Swal.fire({
            title: "Procesando...",
            html: "<div class='spinner-border text-primary' role='status'><span class='visually-hidden'>Cargando...</span></div>",
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
              Swal.showLoading();
            },
          });
          try {
            const res = await fetch("/transfer", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await res.json();
            Swal.close();
            if (result.error) {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: result.error,
                toast: true,
                position: "bottom-end",
                timer: 3000,
                showConfirmButton: false,
              });
            } else {
              // Actualizar saldo
              document.querySelector(
                ".display-6.fw-bold.text-success"
              ).textContent = "$ " + result.saldo;
              // Actualizar tabla de transacciones usando DataTable
              const table = $("#tabla-transacciones").DataTable();
              table.clear();
              if (result.transacciones && result.transacciones.length > 0) {
                result.transacciones.forEach(function (tx) {
                  table.row.add([
                    tx.fecha,
                    tx.destino || tx.origen || "",
                    `<span class='fw-bold ${
                      tx.tipo === "Ingreso" ? "text-success" : "text-danger"
                    }'>$ ${tx.monto}</span>`,
                    tx.tipo === "Ingreso"
                      ? '<span class="badge bg-success">Ingreso</span>'
                      : tx.tipo === "Salida"
                      ? '<span class="badge bg-danger">Salida</span>'
                      : '<span class="badge bg-secondary">-</span>',
                  ]);
                });
              }
              table.draw();
              Swal.fire({
                icon: "success",
                title: "Transferencia realizada",
                toast: true,
                position: "bottom-end",
                timer: 3000,
                showConfirmButton: false,
              });
              form.reset();
            }
          } catch (err) {
            Swal.close();
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Error de red o servidor.",
              toast: true,
              position: "bottom-end",
              timer: 3000,
              showConfirmButton: false,
            });
          }
        });
    </script>
  </body>
</html>
